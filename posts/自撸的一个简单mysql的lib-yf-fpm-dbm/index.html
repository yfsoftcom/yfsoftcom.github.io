<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.78.2"><meta name=viewport content="width=device-width,initial-scale=1"><title>自撸的一个简单mysql的lib[yf-fpm-dbm] &#183; Wang3</title><meta name=description content><link type=text/css rel=stylesheet href=https://blog.yunplus.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://blog.yunplus.io/css/poole.css><link type=text/css rel=stylesheet href=https://blog.yunplus.io/css/syntax.css><link type=text/css rel=stylesheet href=https://blog.yunplus.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><meta name=baidu-site-verification content="hukmWhOg1i"><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?bb3408a776ca96ae2966f50b4f152271";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://blog.yunplus.io/><h1>Wang3</h1></a><p class=lead>A Blog For Wang3</p></div><nav><ul class=sidebar-nav><li><a href=https://blog.yunplus.io/>Home</a></li><li><a href=/categories/>Categories</a></li><li><a href=https://github.com/yfsoftcom/>Github</a></li><li><a href=/tags/>Tags</a></li><li><a href=/source/>推荐资源整理</a></li></ul></nav><p>&copy; 2020. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>自撸的一个简单mysql的lib[yf-fpm-dbm]</h1><time datetime=2017-02-20T18:05:00Z class=post-date>Mon, Feb 20, 2017</time><h3 id=0-起因>0. 起因</h3><p>为了省事，不想引入太多的npm包来实现一个简单的小应用，要足够自由，直接通过json来定义数据就可以实现数据库的操作。
如果你和我一样追求简单的快乐，欢迎前来拍砖；奉上gayhub地址: <a href=https://github.com/team4yf/yf-fpm-dbm>https://github.com/team4yf/yf-fpm-dbm</a>。</p><h3 id=1-特性>1. 特性</h3><ul><li>只使用了2个依赖 [&lsquo;lodash&rsquo;, &lsquo;mysql&rsquo;]</li><li>所有的代码加上格式化的空行不超过 600 行</li><li>目前支持mysql</li><li>通过delflag实现逻辑删除</li><li>默认带有四个字段：id,createAt,updateAt,delflag</li><li>支持批量插入</li><li>支持事务处理</li><li>如果你熟知bluebird,可以更优雅的使用</li></ul><h3 id=2-使用>2. 使用</h3><ul><li><p>安装
<code>npm install yf-fpm-dbm</code></p></li><li><p>配置数据库链接信息</p></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>C</span> <span style=color:#f92672>=</span> {
  <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;192.168.1.1&#39;</span>,
  <span style=color:#a6e22e>database</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;test&#39;</span>,
  <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;root&#39;</span>,
  <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;root&#39;</span>,
};
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>M</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;yf-fpm-dbm&#39;</span>)(<span style=color:#a6e22e>C</span>);
</code></pre></div><ul><li>运行</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>arg</span> <span style=color:#f92672>=</span> {
　<span style=color:#a6e22e>table</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;test&#34;</span>,
　<span style=color:#a6e22e>condition</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;delflag=0&#34;</span>,
　<span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;id,article,ptags,product&#34;</span>
};
<span style=color:#a6e22e>M</span>.<span style=color:#a6e22e>first</span>(<span style=color:#a6e22e>arg</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>error</span>, <span style=color:#a6e22e>data</span>){
  <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>error</span>){
  　<span style=color:#75715e>// do error here
</span><span style=color:#75715e></span>  }<span style=color:#66d9ef>else</span>{
    <span style=color:#75715e>// do success here
</span><span style=color:#75715e></span>  }
});
</code></pre></div><ul><li>说一下事务的用法</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>M</span>.<span style=color:#a6e22e>transation</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>atom</span>){
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>arg</span> <span style=color:#f92672>=</span> {
  　<span style=color:#a6e22e>table</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;test&#34;</span>,
  　<span style=color:#a6e22e>condition</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;...&#34;</span>,
    <span style=color:#a6e22e>row</span><span style=color:#f92672>:</span> { ... }
  };
  <span style=color:#a6e22e>atom</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>arg</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>result1</span>){
    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>err</span>){
      <span style=color:#a6e22e>atom</span>.<span style=color:#a6e22e>rollback</span>();
      <span style=color:#66d9ef>return</span> ;
    }
    <span style=color:#a6e22e>arg</span> <span style=color:#f92672>=</span> {
    　<span style=color:#a6e22e>table</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;test&#34;</span>,
    　<span style=color:#a6e22e>condition</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;...&#34;</span>,
      <span style=color:#a6e22e>row</span><span style=color:#f92672>:</span>{ ... }
    };
    <span style=color:#a6e22e>atom</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>arg</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>result2</span>){
      <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>err</span>){
        <span style=color:#a6e22e>atom</span>.<span style=color:#a6e22e>rollback</span>(<span style=color:#66d9ef>function</span>(){
          <span style=color:#75715e>//do rollback code
</span><span style=color:#75715e></span>        });
      }<span style=color:#66d9ef>else</span>{
        <span style=color:#a6e22e>atom</span>.<span style=color:#a6e22e>commit</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>){
          <span style=color:#75715e>// do commit code
</span><span style=color:#75715e></span>        });
      }
    });
  });
});
</code></pre></div><p>是不是足够的简单?</p><h3 id=3-小总结>3. 小总结</h3><ul><li>造小而精的轮子是个好习惯</li><li>努力做到明显没有bug,像 lodash 这样的lib一样</li><li>持续改进,每次改进都可以减少一些代码,让它更轻更冥界,但更强壮更易读</li></ul><blockquote><p>我来自扬州,一个正在努力成为开源世界一员的一位新人.</p></blockquote></div></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-153851706-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>