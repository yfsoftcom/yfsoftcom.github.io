<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.78.2"><meta name=viewport content="width=device-width,initial-scale=1"><title>关于解决类似「大众点评」字体反爬的方法 &#183; Wang3</title><meta name=description content><meta property="og:title" content="关于解决类似「大众点评」字体反爬的方法"><link type=text/css rel=stylesheet href=https://yfsoftcom.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://yfsoftcom.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://yfsoftcom.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://yfsoftcom.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><meta name=google-site-verification content="TMkOXJMi2Hzjnf06eD_85orpkvedPBEb8iz3QoRAVWw"><meta name=baidu-site-verification content="hukmWhOg1i"><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?bb3408a776ca96ae2966f50b4f152271";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://yfsoftcom.github.io/><h1>Wang3</h1></a><p class=lead>A Blog For Wang3</p></div><nav><ul class=sidebar-nav><li><a href=https://yfsoftcom.github.io/>Home</a></li><li><a href=/categories/>Categories</a></li><li><a href=https://github.com/yfsoftcom/>Github</a></li><li><a href=/posts/node%E4%B8%AD%E7%9A%84eventloop/>Node中的EventLoop</a></li><li><a href=/tags/>Tags</a></li><li><a href=/source/>推荐资源整理</a></li></ul></nav><p>&copy; 2023. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>关于解决类似「大众点评」字体反爬的方法</h1><time datetime=2022-02-11T10:03:00Z class=post-date>Fri, Feb 11, 2022</time><blockquote><p>关于解决类似「大众点评」字体反爬的方法</p></blockquote><p>反爬虫的常规方式通常包括: IP限流, UA 限制, Cookie 限制等。解决办法也比较常规，通过在 Header 中不断更换伪造的信息或者使用代理IP的方式来隐藏自己的爬虫。</p><p>不过机智的反爬虫工程师从来没有停止思考，想出了通过字体文件来隐藏数据；</p><p>大众点评中包含很多商家信息，是一个巨大的数据中心，对于电话和地址这些信息，需要进行反爬；正常用户能看到的信息，通过控制台分析和HTML源码分析得到的却是乱码。</p><p><img src=/snaps/dianping-spider/Untitled.png alt=Untitled></p><p><img src=/snaps/dianping-spider/Untitled%201.png alt=Untitled></p><p>很显然，爬出这样的数据是没有意义的，还是需要继续深入，找到解决办法。</p><p>抓耳挠腮&mldr;&mldr;</p><hr><p>仔细分析发现，它是用字体文件来映射了具体的文字内容，利用CSS样式表来渲染到页面上，单单分析HTML是没有用的，还需要分析字体和样式表文件。</p><p><img src=/snaps/dianping-spider/Untitled%202.png alt=Untitled></p><p><img src=/snaps/dianping-spider/Untitled%203.png alt=Untitled></p><p>下图是通过字体文件打开的 woff 文件，可以看到每个字都对应了一个编码，通过分析，这个编码就对应着页面上的html乱码。</p><p><img src=/snaps/dianping-spider/Untitled%204.png alt=Untitled></p><p>将其中的编码和文字做一个映射，再生成一个python可读的字典来完成替换。</p><p>于是，接下来就是导出文字和编码的映射关系即可。</p><p>简单来说，就是把字体文件中每个字上面对应的编码和字体做一个映射，这听起来很简单，但是没有什么好的办法来完成，只能手动操作。</p><p>虽然没什么技术难度，但是纯粹是体力活，而且伤眼睛，时间长了为数不多的毛发也会脱落。</p><p>感谢大神提供的工具 <code>fontTools</code> ，它可以读取字体文件并识别出文字上面的编码，于是我想到一个骚操作，通过图片转文字，把里面的文字都识别出来，然后通过 fontTools 工具来读取字体文件中的编码，只要2者顺序是一样的，就可以按顺序读取，并添加到字典中。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> fontTools.ttLib <span style=color:#f92672>import</span> TTFont
<span style=color:#f92672>import</span> json

text<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;&#34;1234567890店中美家
</span><span style=color:#e6db74>馆小车大市公酒行国品发电金心业商
</span><span style=color:#e6db74>司超生装园场食有新限天面工服海华
</span><span style=color:#e6db74>水房饰城乐汽香部利子老艺花专东肉
</span><span style=color:#e6db74>菜学福饭人百餐茶务通味所山区门药
</span><span style=color:#e6db74>&#34;&#34;&#34;</span><span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>,<span style=color:#e6db74>&#39;&#39;</span>)

fonts <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#39;address&#39;</span>: <span style=color:#e6db74>&#39;278d416d.woff&#39;</span>, <span style=color:#e6db74>&#39;num&#39;</span>: <span style=color:#e6db74>&#39;278d416d.woff&#39;</span>}
<span style=color:#66d9ef>for</span> n, t <span style=color:#f92672>in</span> fonts<span style=color:#f92672>.</span>items():
	font <span style=color:#f92672>=</span> TTFont(t)  <span style=color:#75715e># 打开本地的ttf文件</span>
	textOrder <span style=color:#f92672>=</span> font<span style=color:#f92672>.</span>getGlyphOrder()[<span style=color:#ae81ff>2</span>:]
	dict <span style=color:#f92672>=</span> {}
	<span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(textOrder)):
		dict[textOrder[i][<span style=color:#ae81ff>3</span>:]] <span style=color:#f92672>=</span> text[i]
	fonts[n] <span style=color:#f92672>=</span> dict
<span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;text.json&#39;</span>, <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> f:
	f<span style=color:#f92672>.</span>write(json<span style=color:#f92672>.</span>dumps(fonts, ensure_ascii <span style=color:#f92672>=</span> False))
</code></pre></div><p>通过这种方式，可以得到一个 <code>text.json</code> 文件，里面包含了编码和文字的对应，后面就可以进行内容的转换了。</p><p>反爬工程师们还会定期更新这个字体文件来提醒我们爬虫要更新了。不过还好，只是改变了文字上面的编码，文字的数量和顺序都没有变化，只要重新跑一下上面的脚本，就可以更新了。</p></div><h2>Comments</h2><script src=https://giscus.app/client.js data-repo=yfsoftcom/yfsoftcom.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk2NDUzNDEzMw==" data-category=General data-category-id=DIC_kwDOA9i2dc4CQcP9 data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-153851706-1','auto');ga('send','pageview');}</script></body></html>