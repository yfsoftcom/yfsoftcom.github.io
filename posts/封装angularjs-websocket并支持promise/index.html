<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.78.2"><meta name=viewport content="width=device-width,initial-scale=1"><title>封装Angularjs Websocket并支持Promise &#183; Wang3</title><meta name=description content><link type=text/css rel=stylesheet href=https://blog.yunplus.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://blog.yunplus.io/css/poole.css><link type=text/css rel=stylesheet href=https://blog.yunplus.io/css/syntax.css><link type=text/css rel=stylesheet href=https://blog.yunplus.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><meta name=baidu-site-verification content="hukmWhOg1i"><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?bb3408a776ca96ae2966f50b4f152271";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://blog.yunplus.io/><h1>Wang3</h1></a><p class=lead>A Blog For Wang3</p></div><nav><ul class=sidebar-nav><li><a href=https://blog.yunplus.io/>Home</a></li><li><a href=/categories/>Categories</a></li><li><a href=https://github.com/yfsoftcom/>Github</a></li><li><a href=/tags/>Tags</a></li><li><a href=/source/>推荐资源整理</a></li></ul></nav><p>&copy; 2020. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>封装Angularjs Websocket并支持Promise</h1><time datetime=2017-02-17T15:15:00Z class=post-date>Fri, Feb 17, 2017</time><p>最近完成了一个ionic项目，服务端是用的websocket，之前还没应用过ws来做前后端的交互；经过这个项目的实践，将这段代码进行封装，并做简要的说明。</p><h3 id=1添加依赖websocket>1.添加依赖[$websocket]</h3><p>这个不多说，这个模块是ng1中使用websocket的不二之选，官方文档也很详细：<a href=https://github.com/gdi2290/angular-websocket>传送门</a>。</p><p>官方实例是这么写的：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVASCRIPT data-lang=JAVASCRIPT>   <span style=color:#a6e22e>angular</span>.<span style=color:#a6e22e>module</span>(<span style=color:#e6db74>&#39;YOUR_APP&#39;</span>, [
     <span style=color:#e6db74>&#39;ngWebSocket&#39;</span> <span style=color:#75715e>// you may also use &#39;angular-websocket&#39; if you prefer
</span><span style=color:#75715e></span>   ])
   <span style=color:#75715e>//                          WebSocket works as well
</span><span style=color:#75715e></span>   .<span style=color:#a6e22e>factory</span>(<span style=color:#e6db74>&#39;MyData&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>$websocket</span>) {
     <span style=color:#75715e>// Open a WebSocket connection
</span><span style=color:#75715e></span>     <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>dataStream</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$websocket</span>(<span style=color:#e6db74>&#39;ws://website.com/data&#39;</span>);

     <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>collection</span> <span style=color:#f92672>=</span> [];

     <span style=color:#a6e22e>dataStream</span>.<span style=color:#a6e22e>onMessage</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>message</span>) {
       <span style=color:#a6e22e>collection</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>));
     });

     <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>methods</span> <span style=color:#f92672>=</span> {
       <span style=color:#a6e22e>collection</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>collection</span>,
       <span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>() {
         <span style=color:#a6e22e>dataStream</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;get&#39;</span> }));
       }
     };

     <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>methods</span>;
   })
   .<span style=color:#a6e22e>controller</span>(<span style=color:#e6db74>&#39;SomeController&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>$scope</span>, <span style=color:#a6e22e>MyData</span>) {
     <span style=color:#a6e22e>$scope</span>.<span style=color:#a6e22e>MyData</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>MyData</span>;
   });

</code></pre></div><p>如果你的项目中没有复杂的交互，仅仅是在一个页面中存取数据，这样已经足够了。</p><p>但往往项目稍微复杂的应用都无法通过这个来满足。</p><p>以下是我个人的简单实现；也仅仅是一种思路的实现，仅供参考 :D</p><h3 id=2将callback转换成promise的实现>2.将callback转换成promise的实现</h3><p>思路核心：</p><blockquote><ol><li>push callback to an array =>
将callback添加到一个数组中得到一个id</li><li>defer with $q.promise =>
通过$q来挂起callback</li><li>send request with a callbackid =>
在发送请求的时候带着这个id</li><li>resolve the promise after websocket.onMessage =>
websocket响应之后通知promise</li><li>get the callback from the array with the callbackid =>
通过返回的callbackid 从数组中取到这个callback</li><li>do the callback code things.
执行想要的代码</li></ol></blockquote><h3 id=3封装过的代码调用起来是这样的>3.封装过的代码调用起来是这样的</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// 引入模块
</span><span style=color:#75715e></span><span style=color:#a6e22e>angular</span>.<span style=color:#a6e22e>module</span>(<span style=color:#e6db74>&#39;YourApp&#39;</span>, [])
  .<span style=color:#a6e22e>controller</span>(<span style=color:#e6db74>&#39;AppCtrl&#39;</span>, [<span style=color:#e6db74>&#39;$scope&#39;</span>, <span style=color:#e6db74>&#39;$rootScope&#39;</span>, <span style=color:#e6db74>&#39;$state&#39;</span>, <span style=color:#e6db74>&#39;$stateParams&#39;</span>, <span style=color:#e6db74>&#39;wsApi&#39;</span>,
    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>$scope</span>, <span style=color:#a6e22e>$rootScope</span>, <span style=color:#a6e22e>$state</span>, <span style=color:#a6e22e>$stateParams</span>, <span style=color:#a6e22e>wsApi</span>) {
      <span style=color:#75715e>//初始化链接信息
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>wsApi</span>.<span style=color:#a6e22e>init</span>({
    		<span style=color:#75715e>//your ws server
</span><span style=color:#75715e></span>          <span style=color:#a6e22e>endpoint</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ws://localhost:8090/ws/test/chat&#39;</span>,
      });
      <span style=color:#75715e>//绑定全局的错误回调
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>wsApi</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#e6db74>&#39;error&#39;</span>, <span style=color:#66d9ef>function</span> () {
        <span style=color:#a6e22e>$scope</span>.<span style=color:#a6e22e>$emit</span>(<span style=color:#e6db74>&#39;WS_ERROR&#39;</span>);
      });
		 <span style=color:#75715e>//绑定全局的关闭回调
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>wsApi</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#e6db74>&#39;close&#39;</span>, <span style=color:#66d9ef>function</span> () {
        <span style=color:#a6e22e>$scope</span>.<span style=color:#a6e22e>$emit</span>(<span style=color:#e6db74>&#39;WS_CLOSE&#39;</span>);
      });
      <span style=color:#75715e>//建立链接
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>wsApi</span>.<span style=color:#a6e22e>connect</span>();
      <span style=color:#75715e>//主动发送数据到服务端
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>wsApi</span>.<span style=color:#a6e22e>Request</span>({<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;hi there&#39;</span>}).<span style=color:#a6e22e>send</span>()
        .<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>data</span>){
          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>data</span>);
        })
        
      <span style=color:#75715e>//订阅频道
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>wsApi</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#e6db74>&#39;foo&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>channel</span>, <span style=color:#a6e22e>id</span>){
        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>data</span>);
      })
      
  })
</code></pre></div><ul><li>下面是封装的完整代码</li></ul><p>y+ws.js文件的代码</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JAVASCRIPT data-lang=JAVASCRIPT><span style=color:#e6db74>&#34;use strict&#34;</span>;

(<span style=color:#66d9ef>function</span>() {

   <span style=color:#a6e22e>angular</span>.<span style=color:#a6e22e>module</span>(<span style=color:#e6db74>&#39;io.y+.ws&#39;</span>, [<span style=color:#e6db74>&#39;ngWebSocket&#39;</span>])
    .<span style=color:#a6e22e>factory</span>(<span style=color:#e6db74>&#39;yws&#39;</span>, [<span style=color:#e6db74>&#39;$websocket&#39;</span>, <span style=color:#e6db74>&#39;$q&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>$websocket</span>, <span style=color:#a6e22e>$q</span>) {
      <span style=color:#75715e>//---- options of the lib
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_options</span> <span style=color:#f92672>=</span> {
        <span style=color:#a6e22e>endpoint</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ws://localhost:8089&#39;</span>,
        <span style=color:#a6e22e>channels</span><span style=color:#f92672>:</span> []
      };

      <span style=color:#75715e>//---- websocket instance
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_dataStream</span>;

      <span style=color:#75715e>//---- callback arrays
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_callbacks</span> <span style=color:#f92672>=</span> {};

      <span style=color:#75715e>//---- listener arrays
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_bindListeners</span> <span style=color:#f92672>=</span> {};

      <span style=color:#75715e>//---- sequence id for callback identify
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_promiseId</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
      <span style=color:#75715e>//
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_Request</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>args</span>){
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_args</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>args</span>;
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_id</span> <span style=color:#f92672>=</span> <span style=color:#f92672>++</span><span style=color:#a6e22e>_promiseId</span>;
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
      };

      <span style=color:#a6e22e>_Request</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_response</span>;
      };

      <span style=color:#a6e22e>_Request</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>send</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(){
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>deferred</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$q</span>.<span style=color:#a6e22e>defer</span>();
        <span style=color:#a6e22e>_callbacks</span>[<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_id</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>deferred</span>;
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_args</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_id</span>;
        <span style=color:#a6e22e>_dataStream</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_args</span>));
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>me</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>;
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>deferred</span>.<span style=color:#a6e22e>promise</span>.<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>response</span>) {
          <span style=color:#a6e22e>me</span>.<span style=color:#a6e22e>_response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>response</span>;
          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
        }).<span style=color:#66d9ef>catch</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>){
          <span style=color:#a6e22e>me</span>.<span style=color:#a6e22e>_error</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>err</span>;
          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>;
        });
      };

      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>funcInit</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(){
        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>_dataStream</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>undefined</span>){
          <span style=color:#a6e22e>_dataStream</span>.<span style=color:#a6e22e>onClose</span>(<span style=color:#66d9ef>function</span>(){
            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;close&#39;</span>);
            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>listener</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>_bindListeners</span>[<span style=color:#e6db74>&#39;close&#39;</span>];
            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>listener</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>undefined</span>){
              <span style=color:#a6e22e>listener</span>(<span style=color:#a6e22e>arguments</span>);
            }
          });
          <span style=color:#a6e22e>_dataStream</span>.<span style=color:#a6e22e>onError</span>(<span style=color:#66d9ef>function</span>(){
            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;error&#39;</span>);
            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>listener</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>_bindListeners</span>[<span style=color:#e6db74>&#39;error&#39;</span>];
            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>listener</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>undefined</span>){
              <span style=color:#a6e22e>listener</span>(<span style=color:#a6e22e>arguments</span>);
            }
          });
          <span style=color:#a6e22e>_dataStream</span>.<span style=color:#a6e22e>onMessage</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>message</span>) {
            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>;
            <span style=color:#75715e>//TODO: check json type
</span><span style=color:#75715e></span>            <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>data</span>);
            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>id</span>;
            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>id</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>undefined</span>){
              <span style=color:#75715e>//event callback
</span><span style=color:#75715e></span>              <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>callback</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>_callbacks</span>[<span style=color:#a6e22e>id</span>];

              <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>callback</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>undefined</span>){
                <span style=color:#66d9ef>delete</span> <span style=color:#a6e22e>_callbacks</span>[<span style=color:#a6e22e>id</span>];
                <span style=color:#a6e22e>callback</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>data</span>);
              }<span style=color:#66d9ef>else</span>{
                <span style=color:#75715e>//TODO: no callback handle;
</span><span style=color:#75715e></span>              }
            }<span style=color:#66d9ef>else</span>{
              <span style=color:#75715e>//mybe boardcast callback
</span><span style=color:#75715e></span>              <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>channel</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>channel</span>;
              <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>channel</span>){
                <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>listener</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>_bindListeners</span>[<span style=color:#a6e22e>channel</span>];
                <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>listener</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>undefined</span>){
                  <span style=color:#a6e22e>listener</span>(<span style=color:#a6e22e>data</span>);
                }
              }<span style=color:#66d9ef>else</span>{
                <span style=color:#75715e>//TODO: unknown message;
</span><span style=color:#75715e></span>              }
            }

          });
        }<span style=color:#66d9ef>else</span>{
          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Fetal~ DataStream Not Defined!&#39;</span>);
        }
      };

      <span style=color:#66d9ef>return</span> {
        <span style=color:#a6e22e>init</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>options</span>){
          <span style=color:#a6e22e>options</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span> <span style=color:#f92672>||</span> {};
          <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>k</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>options</span>){
              <span style=color:#a6e22e>_options</span>[<span style=color:#a6e22e>k</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span>[<span style=color:#a6e22e>k</span>];
          }
          <span style=color:#a6e22e>_dataStream</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$websocket</span>(<span style=color:#a6e22e>_options</span>.<span style=color:#a6e22e>endpoint</span>, <span style=color:#a6e22e>_options</span>.<span style=color:#a6e22e>channels</span>);
          <span style=color:#a6e22e>funcInit</span>();
        },
        <span style=color:#a6e22e>reconnect</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(){
          <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>_dataStream</span>){
            <span style=color:#a6e22e>_dataStream</span>.<span style=color:#a6e22e>reconnect</span>();
          }
        },
        <span style=color:#a6e22e>bind</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>channel</span>, <span style=color:#a6e22e>func</span>){
          <span style=color:#a6e22e>_bindListeners</span>[<span style=color:#a6e22e>channel</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>func</span>;
        },
        <span style=color:#a6e22e>unbind</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>channel</span>){
          <span style=color:#66d9ef>delete</span> <span style=color:#a6e22e>_bindListeners</span>[<span style=color:#a6e22e>channel</span>];
        },
        <span style=color:#a6e22e>Request</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>_Request</span>
      }

   }]);

})();
</code></pre></div><p>将其再进行一次封装
api.js</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>  <span style=color:#a6e22e>angular</span>.<span style=color:#a6e22e>factory</span>(<span style=color:#e6db74>&#39;wsApi&#39;</span>, [<span style=color:#e6db74>&#39;yws&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>ws</span>){
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>TAG</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;wsApi.js&#39;</span>;
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_service</span> <span style=color:#f92672>=</span> {};
    <span style=color:#a6e22e>_service</span>.<span style=color:#a6e22e>init</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>options</span>){
      <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>options</span>);
    };
    <span style=color:#a6e22e>_service</span>.<span style=color:#a6e22e>bind</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>channel</span>, <span style=color:#a6e22e>func</span>) {
      <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#a6e22e>channel</span>, <span style=color:#a6e22e>func</span>);
    };
    <span style=color:#a6e22e>_service</span>.<span style=color:#a6e22e>unbind</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>channel</span>) {
      <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>unbind</span>(<span style=color:#a6e22e>channel</span>);
    };
    <span style=color:#a6e22e>_service</span>.<span style=color:#a6e22e>reconnect</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(){
      <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>reconnect</span>();
    };
    <span style=color:#a6e22e>_service</span>.<span style=color:#a6e22e>connect</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(){
      <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>connect</span>();
    };
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>_service</span>;
}])
</code></pre></div></div></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-153851706-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>